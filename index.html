<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 æ±äº¬&åŒ—æµ·é“å†¬é›ªæ—…ç¨‹å„€è¡¨æ¿ (Live Sync)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 3. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-btn.active {
            background-color: white;
            color: #1e3a8a;
            border-top: 4px solid #3b82f6;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .tab-btn:not(.active) {
            background-color: rgba(30, 58, 138, 0.4);
            color: #dbeafe;
        }
        .tab-btn:not(.active):hover {
            background-color: rgba(30, 58, 138, 0.6);
        }

        /* ç·¨è¼¯æ¨¡å¼ UX å„ªåŒ– */
        [contenteditable="true"]:hover {
            background-color: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
            cursor: text;
        }
        [contenteditable="true"]:focus {
            background-color: white;
            outline: 2px solid #3b82f6;
            border-radius: 4px;
            padding: 2px 4px;
            z-index: 10;
            position: relative;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        
        /* åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        #sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .status-saved { background: #dcfce7; color: #166534; } /* Green */
        .status-saving { background: #fef9c3; color: #854d0e; } /* Yellow */
        .status-error { background: #fee2e2; color: #991b1b; } /* Red */
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800 pb-12" style="display: none;">

    <!-- JS Password Guard (ç°¡æ˜“é˜²è­·) -->
    <script>
        (function() {
            const ACCESS_PASSWORD = "8888"; 
            const isAuth = sessionStorage.getItem('is_dashboard_auth');

            if (isAuth === 'true') {
                document.body.style.display = 'block';
                return;
            }

            setTimeout(() => {
                const input = prompt("è«‹è¼¸å…¥å¯†ç¢¼ä»¥æª¢è¦– 2026 å†¬é›ªä¹‹æ—…è¡Œç¨‹ (Live Syncç‰ˆ)ï¼š\n");
                if (input === ACCESS_PASSWORD) {
                    document.body.style.display = 'block';
                    sessionStorage.setItem('is_dashboard_auth', 'true');
                } else {
                    document.body.style.display = 'flex';
                    document.body.style.justifyContent = 'center';
                    document.body.style.alignItems = 'center';
                    document.body.style.height = '100vh';
                    document.body.innerHTML = `<div style="text-align:center;padding:20px;"><h1>ğŸ”’ Access Denied</h1><button onclick="location.reload()" style="margin-top:10px;padding:5px 10px;">Retry</button></div>`;
                }
            }, 100);
        })();
    </script>

    <!-- Status Indicator -->
    <div id="sync-status" class="status-saved">
        <div class="w-2 h-2 rounded-full bg-green-500" id="sync-dot"></div>
        <span id="sync-text">å·²é€£ç·š</span>
    </div>

    <!-- Header -->
    <header class="bg-blue-900 text-white p-6 shadow-lg relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
            <i data-lucide="snowflake" width="120" height="120"></i>
        </div>
        <div class="max-w-6xl mx-auto relative z-10">
            <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-4">
                <div>
                    <h1 class="text-3xl font-bold tracking-wide mb-2 flex items-center gap-3">
                        <i data-lucide="cloud-lightning" class="text-yellow-400"></i> 
                        2026 æ±äº¬ & åŒ—æµ·é“å†¬é›ªä¹‹æ—…
                    </h1>
                    <p class="text-blue-200 flex items-center gap-2 text-sm md:text-base">
                        <i data-lucide="calendar" width="16"></i> 2026/02/01 - 02/12 (12 Days)
                        <span class="mx-2">|</span>
                        <i data-lucide="users" width="16"></i> 4 Adults
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto -mt-4 px-4 relative z-20">
        
        <!-- Navigation Tabs -->
        <div class="flex gap-1 overflow-x-auto no-scrollbar">
            <button onclick="switchTab('overview')" id="btn-overview" class="tab-btn active flex items-center gap-2 px-6 py-3 rounded-t-lg font-medium transition-colors whitespace-nowrap">
                <i data-lucide="image" width="18"></i> è¡Œç¨‹ç¸½è¦½
            </button>
            <button onclick="switchTab('daily')" id="btn-daily" class="tab-btn flex items-center gap-2 px-6 py-3 rounded-t-lg font-medium transition-colors whitespace-nowrap">
                <i data-lucide="calendar-days" width="18"></i> æ¯æ—¥ç´°ç¯€
            </button>
            <button onclick="switchTab('budget')" id="btn-budget" class="tab-btn flex items-center gap-2 px-6 py-3 rounded-t-lg font-medium transition-colors whitespace-nowrap">
                <i data-lucide="calculator" width="18"></i> é ç®—ä¼°ç®—
            </button>
            <button onclick="switchTab('advisories')" id="btn-advisories" class="tab-btn flex items-center gap-2 px-6 py-3 rounded-t-lg font-medium transition-colors whitespace-nowrap">
                <i data-lucide="alert-triangle" width="18"></i> æ³¨æ„äº‹é …
            </button>
        </div>

        <!-- Content Container -->
        <div class="bg-white rounded-b-xl rounded-tr-xl shadow-xl min-h-[600px] p-4 md:p-8 border border-gray-100">
            
            <!-- 1. Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="flex items-center gap-2 mb-6 border-b pb-2 border-gray-200">
                    <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                        <i data-lucide="map" width="20"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">12å¤©æ¥µè‡´è¡Œç¨‹åœ°åœ–æ¦‚è¦½</h2>
                </div>
                <div class="w-full bg-gray-50 rounded-xl overflow-hidden border border-gray-200 shadow-sm mb-8 flex justify-center items-center min-h-[400px]">
                    <img src="./20260201_0212_Schedule_Ralph.png" 
                         alt="è¡Œç¨‹ç¸½è¦½åœ–ç‰‡" 
                         class="w-full h-auto object-contain max-h-screen"
                         onerror="this.onerror=null; this.src=''; this.parentElement.innerHTML='<div class=\'text-center p-8 text-gray-500\'><i data-lucide=\'image-off\' class=\'mx-auto mb-2 text-gray-400\' width=\'48\'></i><p class=\'font-bold\'>ç„¡æ³•è¼‰å…¥åœ–ç‰‡</p><p class=\'text-sm\'>è«‹ç¢ºèªæª”æ¡ˆ 20260201_0212_Schedule_Ralph.png ä½æ–¼åŒä¸€ç›®éŒ„ã€‚</p></div>'; lucide.createIcons();">
                </div>
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 mt-8">
                    <h3 class="font-bold text-blue-800 mb-4 flex items-center gap-2">
                        <i data-lucide="car" width="18"></i> é‡é»è‡ªé§•è·¯æ®µæé†’ (Google Map å°èˆª)
                    </h3>
                    <div id="mapcode-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm"></div>
                </div>
            </div>

            <!-- 2. Daily Details Tab -->
            <div id="tab-daily" class="tab-content">
                <div class="flex justify-between items-center mb-6 border-b pb-2 border-gray-200">
                    <div class="flex items-center gap-2">
                        <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                            <i data-lucide="calendar-check" width="20"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">æ¯æ—¥è©³ç´°æ—¥ç¨‹è¡¨</h2>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-gray-400 hidden sm:inline-block">æç¤ºï¼šé»æ“Šæ–‡å­—ç·¨è¼¯ï¼Œè‡ªå‹•åŒæ­¥</span>
                        <button onclick="toggleAllDays()" class="text-sm text-blue-600 hover:underline font-medium">å±•é–‹/æ”¶åˆå…¨éƒ¨</button>
                    </div>
                </div>
                <div id="daily-container" class="space-y-4"></div>
            </div>

            <!-- 3. Budget Tab -->
            <div id="tab-budget" class="tab-content">
                <div class="flex items-center gap-2 mb-6 border-b pb-2 border-gray-200">
                    <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                        <i data-lucide="calculator" width="20"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">æ—…è²»é ç®—ä¼°ç®—è¡¨ (TWD)</h2>
                </div>
                <div class="bg-white p-2 md:p-6 rounded-xl border border-gray-200 shadow-sm overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="border-b-2 border-blue-100 text-gray-600">
                                <th class="py-3 pl-2">é …ç›®åˆ†é¡</th>
                                <th class="py-3 w-40">é‡‘é¡ (TWD)</th>
                                <th class="py-3">å‚™è¨»èªªæ˜</th>
                                <th class="py-3 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="budget-tbody"></tbody>
                        <tfoot>
                            <tr class="bg-blue-50 font-bold text-blue-900">
                                <td class="py-3 pl-4">ç¸½è¨ˆé ä¼°</td>
                                <td class="py-3 pr-2 text-right font-mono text-lg" id="budget-total">NT$ 0</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <button onclick="addBudgetItem()" class="mt-4 text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 px-2 py-1 hover:bg-blue-50 rounded">
                        <i data-lucide="plus" width="16"></i> æ–°å¢é ç®—é …ç›®
                    </button>
                </div>
            </div>

            <!-- 4. Advisories Tab -->
            <div id="tab-advisories" class="tab-content">
                <div class="flex items-center gap-2 mb-6 border-b pb-2 border-gray-200">
                    <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                        <i data-lucide="thermometer-snowflake" width="20"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">æ°£å€™èˆ‡æ³¨æ„äº‹é …</h2>
                </div>
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-8">
                    <h3 class="font-bold text-gray-700 mb-4">2æœˆæ°£æº«å°æ¯”ï¼šæ±äº¬ vs æœ­å¹Œ (Â°C)</h3>
                    <div class="relative h-[300px] w-full"><canvas id="tempChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-pink-600 flex items-center gap-2"><i data-lucide="shirt" width="20"></i> é«˜ä¸­å¥³ç”Ÿé›ªåœ°ç©¿æ­</h3>
                            <button onclick="addAdvisoryItem('outfit')" class="text-xs bg-pink-50 text-pink-600 hover:bg-pink-100 px-2 py-1 rounded transition-colors">+ æ–°å¢å»ºè­°</button>
                        </div>
                        <ul id="outfit-list" class="space-y-3 text-sm text-gray-700"></ul>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-blue-800 flex items-center gap-2"><i data-lucide="car" width="20"></i> åŒ—æµ·é“è‡ªé§• & æ»‘é›ª</h3>
                            <button onclick="addAdvisoryItem('drive')" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded transition-colors">+ æ–°å¢æ³¨æ„</button>
                        </div>
                        <ul id="drive-list" class="space-y-3 text-sm text-gray-700"></ul>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- 4. Firebase SDKs & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =======================================================
        // âš ï¸ [Config Area] è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Firebase Config
        // =======================================================
        const firebaseConfig = {
        apiKey: "AIzaSyD4aNoEYhuYBwLGyqZv9JtIE4HFq6uDdlM",
      	authDomain: "winter-japan-trip.firebaseapp.com",
      	projectId: "winter-japan-trip",
      	storageBucket: "winter-japan-trip.firebasestorage.app",
      	messagingSenderId: "670061783968",
      	appId: "1:670061783968:web:9628749ededa595d4d12c5",
      	measurementId: "G-89CDNJH3VZ"

        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global State
        let ITINERARY_DATA = [];
        let OUTFIT_TIPS = [];
        let DRIVE_TIPS = [];
        let budgetItems = [];
        const DOC_ID = "main_travel_plan"; // æ‰€æœ‰ä½¿ç”¨è€…å…±äº«åŒä¸€å€‹ Document
        let isLocalUpdate = false; // Flag to track local edits

        // -----------------------------------------------------
        // DEFAULT DATA (Used for initialization only)
        // -----------------------------------------------------
        const DEFAULT_ITINERARY_DATA = [
            { day: 1, date: "2026/02/01 (æ—¥)", city: "Tokyo", title: "æŠµé”æ±äº¬ & é«˜è¼ª Gateway æ¢ç´¢", icon: "plane", weather: "æ™´ 6Â°C", highlights: ["NH852 æŠµé”ç¾½ç”°", "TAKANAWA GATEWAY CITY", "å“å·æ™šé¤"], stay: "å“å·ç‹å­å¤§é£¯åº— N Tower", transport: "é£›æ©Ÿ (NH852), é›»è»Š", details: [ { id: 101, time: "13:30", action: "NH852 èµ·é£› (TSA æ¾å±±)", type: "transport" }, { id: 102, time: "17:30", action: "æŠµé”æ±äº¬ç¾½ç”° (HND)", type: "transport" }, { id: 103, time: "19:00", action: "é£¯åº— Check-in", location: "Shinagawa Prince Hotel", type: "stay" }, { id: 104, time: "19:30", action: "æ™šé¤ï¼šSingapore Seafood Republic æˆ– Sarabeth's", location: "Shinagawa Station", type: "food" }, { id: 105, time: "21:00", action: "æ¢ç´¢ TAKANAWA GATEWAY CITY (2025æ–°åœ°æ¨™)", location: "Takanawa Gateway Station", type: "activity" } ] },
            { day: 2, date: "2026/02/02 (ä¸€)", city: "Tokyo", title: "å¾¡èŒ¶ä¹‹æ°´é›ªå…· & æ±äº¬æ–°åœ°æ¨™", icon: "shopping-bag", weather: "å¤šé›² 5Â°C", highlights: ["é›ªå…·æ¡è²·", "SHIBUYA SKY", "éº»å¸ƒå°ä¹‹ä¸˜ teamLab"], stay: "å“å·ç‹å­å¤§é£¯åº— N Tower", transport: "é›»è»Š", details: [ { id: 201, time: "10:00", action: "å¾¡èŒ¶ä¹‹æ°´é›ªå…·è¡—æ¡è²· (å…¨å®¶è£å‚™)", location: "Ochanomizu Ski Shop Street", type: "shopping" }, { id: 202, time: "12:30", action: "åˆé¤ï¼šè±šé‡éƒ (ç‚­ç‡’è±šä¸¼) æˆ– Bondy (æ­é¢¨å’–å“©)", location: "Ochanomizu", type: "food" }, { id: 203, time: "14:30", action: "æ¾€è°· SHIBUYA SKY æˆ– éº»å¸ƒå°ä¹‹ä¸˜ teamLab Borderless", location: "SHIBUYA SKY", type: "activity" }, { id: 204, time: "18:30", action: "æ™šé¤ï¼šæ•˜æ•˜è‹‘ (å“å·åº—) æˆ– é³¥è²´æ—", location: "Shinagawa", type: "food" } ] },
            { day: 3, date: "2026/02/03 (äºŒ)", city: "Hokkaido", title: "é£›å¾€åŒ—åœ‹ & è‡ªé§•å‰å¾€ Tomamu", icon: "car", weather: "é›ª -2Â°C", highlights: ["NH61 é£›åƒæ­²", "å–è»Š (Toyota NOAH)", "Club Med"], stay: "Club Med Tomamu", transport: "é£›æ©Ÿ (NH61), è‡ªé§•", details: [ { id: 301, time: "11:00", action: "NH61 èµ·é£› (HND)", type: "transport" }, { id: 302, time: "12:35", action: "æŠµé”æ–°åƒæ­² (CTS)", type: "transport" }, { id: 303, time: "13:30", action: "Worldnet Rent Car å–è»Š (Toyota NOAH/VOXY)", location: "Worldnet Rent a Car New Chitose", type: "transport" }, { id: 304, time: "14:00", action: "åˆé¤ï¼šå¥¥èŠå•†åº— æ¹¯å’–å“© (é®­é­šå…¬åœ’åƒæ­²)", location: "Salmon Park Chitose", type: "food" }, { id: 305, time: "15:30", action: "è‡ªé§•å‰å¾€ Tomamu (MapCode: 602 431 771*27)", location: "Club Med Tomamu", type: "transport" }, { id: 306, time: "18:00", action: "Club Med Buffet æ™šé¤", type: "food" } ] },
            { day: 4, date: "2026/02/04 (ä¸‰)", city: "Hokkaido", title: "Club Med å…¨åŒ…å¼æ»‘é›ªé«”é©—", icon: "snowflake", weather: "å¤§é›ª -6Â°C", highlights: ["åˆ†ç´šæ»‘é›ªèª²ç¨‹", "æ„›çµ²å†°åŸ (Ice Village)"], stay: "Club Med Tomamu", transport: "åº¦å‡æ‘å…§", details: [ { id: 401, time: "09:00", action: "åƒåŠ åˆ†ç´šæ»‘é›ªèª²ç¨‹ / é›ªä¸Šæ´»å‹•", type: "activity" }, { id: 402, time: "12:00", action: "åº¦å‡æ‘åˆé¤", type: "food" }, { id: 403, time: "14:00", action: "ä¸‹åˆæ»‘é›ªç·´ç¿’", type: "activity" }, { id: 404, time: "18:00", action: "æ™šé¤ (å¯é ç´„ç‡’è‚‰ Haku)", type: "food" }, { id: 405, time: "20:00", action: "æ„›çµ²å†°åŸ (Ice Village)ï¼šå†°ä¹‹æ•™å ‚ã€å†°é…’å§", location: "Ice Village Tomamu", type: "activity" } ] },
            { day: 5, date: "2026/02/05 (å››)", city: "Hokkaido", title: "å¾®ç¬‘æµ·ç˜ & éœ²å¤©é›ªè¦‹æº«æ³‰", icon: "snowflake", weather: "é›ª -5Â°C", highlights: ["æ»‘é›ªé€²éš", "Mina-Mina Beach", "æœ¨æ—ä¹‹æ¹¯"], stay: "Club Med Tomamu", transport: "åº¦å‡æ‘å…§", details: [ { id: 501, time: "09:00", action: "ä¸Šåˆæ»‘é›ª/é›ªæ¿èª²ç¨‹", type: "activity" }, { id: 502, time: "14:00", action: "å¾®ç¬‘æµ·ç˜ (Mina-Mina Beach) å®¤å…§é€ æµªæ± ", location: "Mina-Mina Beach", type: "activity" }, { id: 503, time: "16:00", action: "æœ¨æ—ä¹‹æ¹¯ (éœ²å¤©é›ªæ™¯æº«æ³‰)", type: "activity" } ] },
            { day: 6, date: "2026/02/06 (äº”)", city: "Hokkaido", title: "éœ§å†°å¹³å° & é›²æµ·è˜‡æ‰“", icon: "camera", weather: "å¤šé›² -7Â°C", highlights: ["éœ§å†°å¹³å°", "G.O. Show"], stay: "Club Med Tomamu", transport: "çºœè»Š", details: [ { id: 601, time: "09:30", action: "æ­çºœè»Šä¸Šéœ§å†°å¹³å° (Terrace of Frost Tree)", location: "Tomamu Cloud Walk", type: "activity" }, { id: 602, time: "10:30", action: "å“åšé›²æµ·è˜‡æ‰“", type: "food" }, { id: 603, time: "19:30", action: "G.O. Show è¡¨æ¼”ç§€ / ä¸»é¡Œæ´¾å°", type: "activity" } ] },
            { day: 7, date: "2026/02/07 (å…­)", city: "Sapporo", title: "ç§»å‹•è‡³æœ­å¹Œ & é›ªç¥­é»ç‡ˆ", icon: "car", weather: "é›ª -3Â°C", highlights: ["æœ€å¾Œæ»‘é›ª", "æœ­å¹Œé›ªç¥­(å¤§é€šæœƒå ´)"], stay: "VILLA KOSHIDO ODORI", transport: "è‡ªé§• (ç´„2å°æ™‚)", details: [ { id: 701, time: "09:00", action: "æœ€å¾Œæ»‘é›ªæ™‚å…‰", type: "activity" }, { id: 702, time: "12:00", action: "åˆé¤å¾Œé€€æˆ¿å‡ºç™¼ (MapCode: 9 555 061*38)", type: "transport" }, { id: 703, time: "15:30", action: "Check-in VILLA KOSHIDO ODORI", location: "VILLA KOSHIDO ODORI", type: "stay" }, { id: 704, time: "17:30", action: "æœ­å¹Œé›ªç¥­ (å¤§é€šæœƒå ´) æ¬£è³å·¨å‹é›ªé›•é»ç‡ˆ", location: "Odori Park", type: "activity" }, { id: 705, time: "19:30", action: "æ™šé¤ï¼šSuage+ æ¹¯å’–å“© æˆ– é”æ‘©æˆå‰æ€æ±—çƒ¤è‚‰", location: "Susukino", type: "food" } ] },
            { day: 8, date: "2026/02/08 (æ—¥)", city: "Sapporo", title: "å»ºç¯‰å·¡ç¦® & è—»å²©å±±å¤œæ™¯", icon: "map-pin", weather: "æ™´ -2Â°C", highlights: ["F Village", "é ­å¤§ä½›", "è—»å²©å±±å¤œæ™¯"], stay: "VILLA KOSHIDO ODORI", transport: "è‡ªé§•", details: [ { id: 801, time: "09:30", action: "F Village æ£’çƒåœ’å€ (MapCode: 430 460 777*48)", location: "Hokkaido Ballpark F Village", type: "activity" }, { id: 802, time: "11:30", action: "ä¸‰äº• Outlet Park åŒ—å»£å³¶ (åˆé¤: è±šä¸¼ Butahage)", location: "Mitsui Outlet Park Sapporo Kitahiroshima", type: "shopping" }, { id: 803, time: "14:10", action: "é ­å¤§ä½›æ®¿ (å®‰è—¤å¿ é›„è¨­è¨ˆ, 15:00é–‰åœ’, MapCode: 950 792 513)", location: "Hill of the Buddha", type: "activity" }, { id: 804, time: "16:30", action: "è—»å²©å±±çºœè»Š (MapCode: 952 116 6*41)", location: "Mt. Moiwa Ropeway", type: "activity" }, { id: 805, time: "18:30", action: "æ™šé¤ï¼šTHE JEWELS (å±±é ‚æ³•å¼) æˆ– èƒèŸ¹æœ¬å®¶", type: "food" } ] },
            { day: 9, date: "2026/02/09 (ä¸€)", city: "Otaru", title: "å°æ¨½æµªæ¼«é›ªç‡ˆä¹‹è·¯", icon: "snowflake", weather: "é›ª -4Â°C", highlights: ["å°æ¨½é‹æ²³", "å ºç”ºé€š", "é›ªç‡ˆä¹‹è·¯"], stay: "VILLA KOSHIDO ODORI", transport: "è‡ªé§•", details: [ { id: 901, time: "10:00", action: "å‡ºç™¼å‰å¾€å°æ¨½ (MapCode: 493 690 538*13)", type: "transport" }, { id: 902, time: "11:30", action: "åˆé¤ï¼šæ”¿å£½å¸ æˆ– å’Œæ¨‚è¿´è½‰å£½å¸", location: "Otaru Masazushi", type: "food" }, { id: 903, time: "13:30", action: "å ºç”ºé€šé€›è¡— (åŒ—ä¸€ç¡å­ã€éŸ³æ¨‚ç›’å ‚ã€LeTAO)", location: "Sakaimachi Street", type: "shopping" }, { id: 904, time: "17:00", action: "å°æ¨½é›ªç‡ˆä¹‹è·¯ (é‹æ²³æµ®çƒè Ÿç‡­)", location: "Otaru Canal", type: "activity" }, { id: 905, time: "19:30", action: "æ™šé¤ï¼šæ‹‰éºµå…±å’Œåœ‹ æˆ– å†°é›ªä¹‹é–€", location: "Sapporo Ramen Republic", type: "food" } ] },
            { day: 10, date: "2026/02/10 (äºŒ)", city: "Tokyo", title: "ç¾Šä¹‹ä¸˜ & è¿”å›æ±äº¬", icon: "plane", weather: "å¤šé›² 5Â°C", highlights: ["ç¾Šä¹‹ä¸˜å±•æœ›å°", "NH62 è¿”å›æ±äº¬"], stay: "å“å·ç‹å­å¤§é£¯åº— N Tower", transport: "è‡ªé§•, é£›æ©Ÿ (NH62)", details: [ { id: 1001, time: "09:30", action: "ç¾Šä¹‹ä¸˜å±•æœ›å° (MapCode: 952 728 8*46)", location: "Hitsujigaoka Observation Hill", type: "activity" }, { id: 1002, time: "10:30", action: "å‰å¾€ Worldnet Rent Car é‚„è»Š", location: "Worldnet Rent a Car New Chitose", type: "transport" }, { id: 1003, time: "11:30", action: "æ©Ÿå ´åˆé¤ï¼šä¸€å¹»æ‹‰éºµ / Kinotoya", location: "New Chitose Airport", type: "food" }, { id: 1004, time: "12:30", action: "NH62 èµ·é£› (CTS)", type: "transport" }, { id: 1005, time: "14:10", action: "æŠµé”æ±äº¬ç¾½ç”° (HND)", type: "transport" }, { id: 1006, time: "18:00", action: "æ™šé¤ï¼šTsubame Grill æ¼¢å ¡æ’", location: "Tsubame Grill Shinagawa", type: "food" } ] },
            { day: 11, date: "2026/02/11 (ä¸‰)", city: "Tokyo", title: "è®€è³£æ¨‚åœ’ & å¯¶å¯å¤¢ KANTO", icon: "camera", weather: "æ™´ 7Â°C", highlights: ["å¯¶å¯å¤¢æ¨‚åœ’ KANTO", "å¯¶çŸ³ç‡ˆå…‰ç§€"], stay: "å“å·ç‹å­å¤§é£¯åº— N Tower", transport: "é›»è»Š", details: [ { id: 1101, time: "10:00", action: "å‰å¾€è®€è³£æ¨‚åœ’ (Yomiuriland)", location: "Yomiuriland", type: "activity" }, { id: 1102, time: "11:00", action: "æ¢ç´¢ PokÃ©Park KANTO (é è¨ˆé–‹å¹•)", type: "activity" }, { id: 1103, time: "13:00", action: "åˆé¤ï¼šæ¨‚åœ’å…§å¯¶å¯å¤¢ä¸»é¡Œé¤å»³", type: "food" }, { id: 1104, time: "17:00", action: "å¯¶çŸ³ç‡ˆå…‰ç§€ (Jewellumination)", type: "activity" }, { id: 1105, time: "19:30", action: "æ™šé¤ï¼šå…­æ­Œä»™ (æ–°å®¿ç‡’è‚‰) æˆ– HARBS", location: "Rokkasen", type: "food" } ] },
            { day: 12, date: "2026/02/12 (å››)", city: "Tokyo", title: "æœ€å¾Œæ¡è²· & è³¦æ­¸", icon: "plane", weather: "å¤šé›² 8Â°C", highlights: ["Ecute å“å·ä¼´æ‰‹ç¦®", "NH853 è¿”å›å°åŒ—"], stay: "æº«æš–çš„å®¶", transport: "è¨ˆç¨‹è»Š, é£›æ©Ÿ (NH853)", details: [ { id: 1201, time: "09:00", action: "Ecute å“å·æœ€å¾Œæ¡è²· (Butter Butler, Sugar Butter Tree)", location: "ecute Shinagawa", type: "shopping" }, { id: 1202, time: "10:30", action: "æ­è¨ˆç¨‹è»Šå‰å¾€ç¾½ç”°æ©Ÿå ´", type: "transport" }, { id: 1203, time: "12:40", action: "NH853 èµ·é£› (HND)", type: "transport" }, { id: 1204, time: "15:50", action: "æŠµé”å°åŒ—æ¾å±± (TSA)", type: "transport" } ] }
        ];

        const DEFAULT_OUTFIT_TIPS = [
            {id: 1, text: "<strong>æ´‹è”¥å¼ç©¿æ³•ï¼š</strong>ç™¼ç†±è¡£ + é‡ç¹”æ¯›è¡£ + é˜²é¢¨é˜²æ°´é•·ç‰ˆç¾½çµ¨å¤–å¥—ï¼ˆé€²å®¤å…§æœ‰æš–æ°£å¯è„«ï¼‰ã€‚"},
            {id: 2, text: "<strong>ä¸‹åŠèº«ï¼š</strong>å…§æ­åˆ·æ¯›è¤²è¥ª + å¯¬è¤²æˆ–è£™è£ï¼ˆæ‹ç…§å¥½çœ‹ï¼‰ï¼Œæˆ–ç›´æ¥ç©¿é˜²æ°´é›ªè¤²ï¼ˆæ»‘é›ªæ™‚ï¼‰ã€‚"},
            {id: 3, text: "<strong>é…ä»¶å¿…å‚™ï¼š</strong>æ¯›å¸½ï¼ˆé®è€³ï¼‰ã€åœå·¾ã€æ‰‹å¥—ï¼ˆé˜²æ°´æ¬¾ç‚ºä½³ï¼‰ã€æš–æš–åŒ…ï¼ˆè²¼å¼ï¼‰ã€‚"},
            {id: 4, text: "<strong>é‹å­é—œéµï¼š</strong>é˜²æ»‘é˜²æ°´é›ªé´æ˜¯å¿…é ˆçš„ï¼ä¸€èˆ¬çƒé‹åœ¨çµå†°è·¯é¢éå¸¸å±éšªã€‚å»ºè­°åœ¨ç•¶åœ°è²·ã€Œé˜²æ»‘é‹å¢Šã€ã€‚"}
        ];

        const DEFAULT_DRIVE_TIPS = [
            {id: 1, text: "<strong>é›ªåœ°é§•é§›ï¼š</strong>åˆ‡å‹¿æ€¥è¸©ç…è»Šï¼èµ·æ­¥è¦æ…¢ã€‚é‡åˆ°æš´é¢¨é›ªï¼ˆWhiteoutï¼‰è«‹é–‹å•Ÿé›™é»ƒç‡ˆä¸¦é é‚Šæš«åœã€‚"},
            {id: 2, text: "<strong>å°èˆªæŠ€å·§ï¼š</strong>å„ªå…ˆä½¿ç”¨ MapCodeã€‚å±±å€è¨Šè™Ÿå¯èƒ½ä¸ä½³ï¼Œå»ºè­°ä¸‹è¼‰é›¢ç·šåœ°åœ–ã€‚"},
            {id: 3, text: "<strong>æ»‘é›ªå®‰å…¨ï¼š</strong>Club Med èª²ç¨‹åˆ†ç´šåš´è¬¹ï¼Œè«‹èª å¯¦å‘ŠçŸ¥ç¨‹åº¦ã€‚é›ªé¡å¿…æˆ´ï¼ˆé é˜²é›ªç›²ï¼‰ã€‚"},
            {id: 4, text: "<strong>è¡Œç¨‹å½ˆæ€§ï¼š</strong>å†¬æ—¥äº¤é€šæ˜“å—å¤©æ°£å½±éŸ¿ï¼ˆJRåœé§›/é«˜é€Ÿå…¬è·¯å°é–‰ï¼‰ï¼Œå‹™å¿…é ç•™ç·©è¡æ™‚é–“ã€‚"}
        ];

        const DEFAULT_BUDGET_ITEMS = [
            { id: 1, category: "æ©Ÿç¥¨ (4äºº)", amount: 88000, note: "NHæ¾å±±ç¾½ç”° + å…§é™¸æ®µ" },
            { id: 2, category: "ä½å®¿ (11æ™š)", amount: 180000, note: "Club Med 3æ™šå…¨åŒ… + å¸‚å€é£¯åº—" },
            { id: 3, category: "ç§Ÿè»Š (8å¤©)", amount: 35000, note: "Toyota NOAH + ä¿éšª + ETC" },
            { id: 4, category: "é¤é£²", amount: 60000, note: "å«ç‡’è‚‰ã€èƒèŸ¹å¤§é¤é ç®—" },
            { id: 5, category: "é–€ç¥¨/é«”é©—", amount: 25000, note: "æ»‘é›ªèª²ã€çºœè»Šã€æ¨‚åœ’" },
            { id: 6, category: "è³¼ç‰©é å‚™é‡‘", amount: 50000, note: "ä¼´æ‰‹ç¦®ã€é›ªå…·" },
        ];

        const MAP_CODES = { "Club Med Tomamu": "602 431 771*27", "VILLA KOSHIDO ODORI": "9 555 061*38", "F Village": "430 460 777*48", "Hill of the Buddha": "950 792 513", "Mt. Moiwa Ropeway": "952 116 6*41", "Otaru Canal": "493 690 538*13", "Hitsujigaoka": "952 728 8*46", "Worldnet Return": "0123-21-8558" };

        // -----------------------------------------------------
        // LOGIC & FUNCTIONS
        // -----------------------------------------------------

        // Debounce: é˜²æ­¢çŸ­æ™‚é–“å…§å¤§é‡å¯«å…¥ Firestore
        function debounce(func, timeout = 1000){
            let timer;
            return (...args) => {
                clearTimeout(timer);
                updateStatus('saving');
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        // Firestore Listener (Read)
        const unsub = onSnapshot(doc(db, "trips", DOC_ID), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°ç«¯å‰›ç™¼å‡ºçš„å¯«å…¥ (Latency Compensation)
                const isPending = docSnap.metadata.hasPendingWrites;
                
                if (isPending) {
                    // å¦‚æœæ˜¯æœ¬åœ°å‰›å¯«çš„ï¼Œä¸è¦é‡ç¹ª DOMï¼Œä»¥å… contenteditable ç„¦é»è·‘æ‰
                    console.log("Local write detected, skipping render to preserve focus.");
                    return;
                }

                console.log("Remote update detected, re-rendering.");
                ITINERARY_DATA = data.ITINERARY_DATA || [];
                OUTFIT_TIPS = data.OUTFIT_TIPS || [];
                DRIVE_TIPS = data.DRIVE_TIPS || [];
                budgetItems = data.budgetItems || [];
                
                renderAll();
                updateStatus('saved');
            } else {
                console.log("No such document! Initializing defaults...");
                initializeDefaultData();
            }
        }, (error) => {
            console.error("Firestore Error:", error);
            updateStatus('error');
        });

        // Firestore Save (Write)
        const saveToCloud = debounce(async () => {
            try {
                await setDoc(doc(db, "trips", DOC_ID), {
                    ITINERARY_DATA,
                    OUTFIT_TIPS,
                    DRIVE_TIPS,
                    budgetItems
                }, { merge: true });
                updateStatus('saved');
            } catch (e) {
                console.error("Error adding document: ", e);
                updateStatus('error');
            }
        });

        async function initializeDefaultData() {
            ITINERARY_DATA = DEFAULT_ITINERARY_DATA;
            OUTFIT_TIPS = DEFAULT_OUTFIT_TIPS;
            DRIVE_TIPS = DEFAULT_DRIVE_TIPS;
            budgetItems = DEFAULT_BUDGET_ITEMS;
            await saveToCloud();
            renderAll();
        }

        function updateStatus(status) {
            const el = document.getElementById('sync-status');
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');
            
            el.className = ''; 
            if (status === 'saved') {
                el.classList.add('status-saved');
                dot.className = 'w-2 h-2 rounded-full bg-green-500';
                text.innerText = 'é›²ç«¯å·²åŒæ­¥';
            } else if (status === 'saving') {
                el.classList.add('status-saving');
                dot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                text.innerText = 'å„²å­˜ä¸­...';
            } else {
                el.classList.add('status-error');
                dot.className = 'w-2 h-2 rounded-full bg-red-500';
                text.innerText = 'åŒæ­¥å¤±æ•—';
            }
        }

        // --- WINDOW EXPORTS (HTML onclick bindings) ---
        
        window.switchTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`btn-${tabId}`).classList.add('active');
        }

        window.toggleAllDays = function() {
            const firstDay = document.getElementById('day-content-1');
            const isHidden = firstDay && firstDay.classList.contains('hidden');
            ITINERARY_DATA.forEach(day => {
                const el = document.getElementById(`day-content-${day.day}`);
                if(el) {
                    if(isHidden) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            });
            lucide.createIcons();
        }

        window.toggleDay = function(dayId) {
            const el = document.getElementById(`day-content-${dayId}`);
            if(el) el.classList.toggle('hidden');
            lucide.createIcons();
        }

        window.openGoogleMaps = function(query) {
            if (!query) return;
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        }

        // Update handlers now modify JS variables AND trigger Cloud Save
        window.updateDailyDetail = function(dayId, detailId, field, value) {
            const day = ITINERARY_DATA.find(d => d.day === dayId);
            const detail = day.details.find(d => d.id === detailId);
            if (detail) {
                detail[field] = value;
                saveToCloud();
            }
        }

        window.addDailyDetail = function(dayId) {
            const day = ITINERARY_DATA.find(d => d.day === dayId);
            day.details.push({ id: Date.now(), time: "00:00", action: "æ–°è¡Œç¨‹", type: "activity", location: "" });
            saveToCloud();
            renderDaily(); // Immediate local render for better UX on add
            // Re-open day if closed
            const el = document.getElementById(`day-content-${dayId}`);
            if(el) el.classList.remove('hidden');
            lucide.createIcons();
        }

        window.removeDailyDetail = function(dayId, detailId) {
            if(confirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                const day = ITINERARY_DATA.find(d => d.day === dayId);
                day.details = day.details.filter(d => d.id !== detailId);
                saveToCloud();
                renderDaily(); // Immediate local render
                const el = document.getElementById(`day-content-${dayId}`);
                if(el) el.classList.remove('hidden');
                lucide.createIcons();
            }
        }

        window.updateBudget = function(id, field, value) {
            const idx = budgetItems.findIndex(i => i.id === id);
            if(idx !== -1) {
                budgetItems[idx][field] = field === 'amount' ? Number(value) : value;
                saveToCloud();
                // We assume user is typing, so we let debouncer handle it. 
                // We do NOT call renderBudget() here to avoid focus loss on input fields.
                // However, for total calculation updates, we might want to update the total text specifically.
                if(field === 'amount') {
                     const total = budgetItems.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
                     const totalEl = document.getElementById('budget-total');
                     if(totalEl) totalEl.innerText = 'NT$ ' + total.toLocaleString();
                }
            }
        }

        window.removeBudget = function(id) {
            budgetItems = budgetItems.filter(i => i.id !== id);
            saveToCloud();
            renderBudget();
        }

        window.addBudgetItem = function() {
            budgetItems.push({ id: Date.now(), category: "æ–°é …ç›®", amount: 0, note: "" });
            saveToCloud();
            renderBudget();
        }

        window.updateAdvisory = function(type, id, newText) {
            const list = type === 'outfit' ? OUTFIT_TIPS : DRIVE_TIPS;
            const item = list.find(i => i.id === id);
            if(item) {
                item.text = newText;
                saveToCloud();
            }
        }

        window.addAdvisoryItem = function(type) {
            const list = type === 'outfit' ? OUTFIT_TIPS : DRIVE_TIPS;
            list.push({ id: Date.now(), text: "ç·¨è¼¯æ–°å»ºè­°..." });
            saveToCloud();
            renderAdvisories();
        }

        window.removeAdvisory = function(type, id) {
            if(type === 'outfit') OUTFIT_TIPS = OUTFIT_TIPS.filter(i => i.id !== id);
            else DRIVE_TIPS = DRIVE_TIPS.filter(i => i.id !== id);
            saveToCloud();
            renderAdvisories();
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderDaily();
            renderMapCodes();
            renderBudget();
            renderAdvisories();
            lucide.createIcons();
        }

        function renderDaily() {
            const container = document.getElementById('daily-container');
            if(!container) return;
            container.innerHTML = ITINERARY_DATA.map(day => `
                <div class="border border-gray-200 rounded-lg overflow-hidden transition-all hover:border-blue-300">
                    <div onclick="toggleDay(${day.day})" class="flex flex-col md:flex-row md:items-center p-4 bg-gray-50 cursor-pointer hover:bg-blue-50/50 select-none">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="bg-blue-600 text-white w-12 h-12 rounded-lg flex flex-col items-center justify-center shrink-0 shadow-sm">
                                <span class="text-xs font-light">Day</span>
                                <span class="text-xl font-bold leading-none">${day.day}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">${day.title}</h3>
                                <div class="flex items-center gap-3 text-sm text-gray-500 mt-1">
                                    <span>${day.date}</span>
                                    <span class="flex items-center gap-1"><i data-lucide="map-pin" width="12"></i> ${day.city}</span>
                                    <span class="flex items-center gap-1 bg-white px-2 rounded-full shadow-sm"><i data-lucide="${day.icon}" width="12"></i> ${day.weather}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mt-3 md:mt-0 justify-between md:justify-end w-full md:w-auto">
                            <div class="text-right hidden md:block">
                                <div class="text-xs text-gray-400">ä½å®¿</div>
                                <div class="text-sm font-medium text-gray-700 truncate max-w-[150px]">${day.stay}</div>
                            </div>
                            <div class="text-gray-400"><i data-lucide="chevron-down" width="20"></i></div>
                        </div>
                    </div>
                    <div id="day-content-${day.day}" class="hidden p-4 bg-white border-t border-gray-100">
                        <div class="relative border-l-2 border-blue-100 ml-3 pl-6 space-y-6 py-2">
                            ${day.details.map(detail => `
                                <div class="relative group hover:bg-gray-50 p-2 rounded -ml-2">
                                    <div class="absolute -left-[23px] top-4 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10 ${detail.type === 'transport' ? 'bg-gray-400' : detail.type === 'food' ? 'bg-orange-400' : detail.type === 'shopping' ? 'bg-pink-400' : 'bg-blue-500'}"></div>
                                    <div class="flex flex-col sm:flex-row sm:items-start gap-1 sm:gap-4 w-full">
                                        <div contenteditable="true" onblur="updateDailyDetail(${day.day}, ${detail.id}, 'time', this.innerText)" class="font-mono text-sm font-bold text-gray-500 w-12 shrink-0 pt-0.5 border-b border-dashed border-transparent hover:border-gray-300">${detail.time}</div>
                                        <div class="flex-1 w-full">
                                            <div contenteditable="true" onblur="updateDailyDetail(${day.day}, ${detail.id}, 'action', this.innerText)" class="font-medium text-gray-800 border-b border-dashed border-transparent hover:border-gray-300">${detail.action}</div>
                                            <div class="flex items-center gap-2 mt-1">
                                                <button onclick="event.stopPropagation(); openGoogleMaps('${detail.location || ''}')" class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 font-medium bg-blue-50 hover:bg-blue-100 px-1.5 py-0.5 rounded border border-blue-100"><i data-lucide="map-pin" width="12"></i></button>
                                                <div contenteditable="true" onblur="updateDailyDetail(${day.day}, ${detail.id}, 'location', this.innerText)" class="text-xs text-gray-500 hover:text-blue-600 border-b border-dashed border-transparent hover:border-gray-300 min-w-[50px]">${detail.location || 'æ–°å¢åœ°é»...'}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeDailyDetail(${day.day}, ${detail.id})" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-opacity p-1"><i data-lucide="x" width="16"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addDailyDetail(${day.day})" class="ml-8 mt-2 text-sm text-blue-500 hover:text-blue-700 flex items-center gap-1 px-2 py-1 hover:bg-blue-50 rounded"><i data-lucide="plus" width="14"></i> æ–°å¢è¡Œç¨‹</button>
                    </div>
                </div>
            `).join('');
        }

        function renderMapCodes() {
            const container = document.getElementById('mapcode-grid');
            if(!container) return;
            container.innerHTML = Object.entries(MAP_CODES).map(([name, code]) => `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-3 rounded shadow-sm border border-gray-100 gap-2">
                    <button onclick="openGoogleMaps('${name}')" class="font-medium text-blue-600 hover:text-blue-800 flex items-center gap-1 transition-colors text-left"><i data-lucide="map-pin" width="16"></i> ${name}</button>
                    <code class="bg-gray-100 px-2 py-1 rounded text-gray-600 font-mono select-all cursor-pointer hover:bg-gray-200 text-xs sm:text-sm whitespace-nowrap">${code}</code>
                </div>
            `).join('');
        }

        function renderBudget() {
            const tbody = document.getElementById('budget-tbody');
            if(!tbody) return;
            tbody.innerHTML = budgetItems.map(item => `
                <tr class="border-b border-gray-100 hover:bg-gray-50 group transition-colors">
                    <td class="py-2 pl-2"><input type="text" value="${item.category}" onchange="updateBudget(${item.id}, 'category', this.value)" class="w-full bg-transparent focus:outline-none focus:ring-1 focus:ring-blue-300 rounded px-1 py-1"></td>
                    <td class="py-2"><input type="number" value="${item.amount}" onchange="updateBudget(${item.id}, 'amount', this.value)" class="w-full bg-transparent font-mono text-right focus:outline-none focus:ring-1 focus:ring-blue-300 rounded px-1 py-1"></td>
                    <td class="py-2 text-gray-500 text-sm"><input type="text" value="${item.note}" onchange="updateBudget(${item.id}, 'note', this.value)" class="w-full bg-transparent focus:outline-none focus:ring-1 focus:ring-blue-300 rounded px-1 py-1"></td>
                    <td class="py-2 text-center"><button onclick="removeBudget(${item.id})" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity px-2">Ã—</button></td>
                </tr>
            `).join('');
            const total = budgetItems.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
            document.getElementById('budget-total').innerText = 'NT$ ' + total.toLocaleString();
        }

        function renderAdvisories() {
            const outfitList = document.getElementById('outfit-list');
            const driveList = document.getElementById('drive-list');
            
            if(outfitList) outfitList.innerHTML = OUTFIT_TIPS.map(item => `<li class="flex gap-2 group"><span class="text-pink-400 font-bold shrink-0">â€¢</span><span contenteditable="true" onblur="updateAdvisory('outfit', ${item.id}, this.innerHTML)" class="flex-1 border-b border-dashed border-transparent hover:border-gray-300">${item.text}</span><button onclick="removeAdvisory('outfit', ${item.id})" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-opacity px-1">Ã—</button></li>`).join('');
            if(driveList) driveList.innerHTML = DRIVE_TIPS.map(item => `<li class="flex gap-2 group"><span class="text-blue-500 font-bold shrink-0">â€¢</span><span contenteditable="true" onblur="updateAdvisory('drive', ${item.id}, this.innerHTML)" class="flex-1 border-b border-dashed border-transparent hover:border-gray-300">${item.text}</span><button onclick="removeAdvisory('drive', ${item.id})" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-opacity px-1">Ã—</button></li>`).join('');
        }

        function initChart() {
            const ctx = document.getElementById('tempChart');
            if(!ctx) return;
            new Chart(ctx.getContext('2d'), { type: 'line', data: { labels: ['æ—©æ™¨', 'ä¸­åˆ', 'å‚æ™š', 'æ·±å¤œ'], datasets: [{ label: 'æ±äº¬', data: [2, 8, 5, 1], borderColor: '#f59e0b', backgroundColor: '#f59e0b' }, { label: 'æœ­å¹Œ', data: [-6, -1, -4, -7], borderColor: '#3b82f6', backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderMapCodes();
            lucide.createIcons();
            initChart();
            // Data loading is handled by Firestore onSnapshot
        });
    </script>
</body>
</html>
